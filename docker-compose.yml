services:
  # ===========================
  # NGINX
  # ===========================
  nginx:
    image: nginx:alpine
    container_name: crm-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./:/var/www/crm
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/sites:/etc/nginx/conf.d:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - ./frontend/dist:/var/www/frontend:ro
    depends_on:
      - php
      - reverb
      - ai-service
    networks:
      - crm-network

  # ===========================
  # PHP-FPM (backend Laravel)
  # ===========================
  php:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: crm-php
    restart: unless-stopped
    working_dir: /var/www/crm
    volumes:
      - ./:/var/www/crm
      - ./docker/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
    environment:
      APP_ENV: ${APP_ENV:-production}
      DB_CONNECTION: pgsql
      DB_HOST: ${DB_HOST}
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REVERB_HOST: reverb
      REVERB_PORT: 8080
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - crm-network

  # ===========================
  # Reverb (WebSocket Server)
  # ===========================
  reverb:
    build:
      context: .
      dockerfile: docker/php/Dockerfile.reverb
    container_name: crm-reverb
    restart: unless-stopped
    working_dir: /var/www/crm
    command: sh -c "sleep 5 && php artisan reverb:start --host=0.0.0.0 --port=8080"
    volumes:
      - ./:/var/www/crm
    environment:
      APP_ENV: ${APP_ENV:-production}
      DB_CONNECTION: pgsql
      DB_HOST: ${DB_HOST}
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REVERB_APP_ID: ${REVERB_APP_ID}
      REVERB_APP_KEY: ${REVERB_APP_KEY}
      REVERB_APP_SECRET: ${REVERB_APP_SECRET}
      REVERB_HOST: 0.0.0.0
      REVERB_PORT: 8080
    depends_on:
      php:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - crm-network

  # ===========================
  # Queue Worker
  # ===========================
  queue:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: crm-queue
    restart: unless-stopped
    working_dir: /var/www/crm
    command: php artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
    volumes:
      - ./:/var/www/crm
    environment:
      APP_ENV: ${APP_ENV:-production}
      DB_CONNECTION: pgsql
      DB_HOST: ${DB_HOST}
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      php:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - crm-network

  # ===========================
  # Scheduler
  # ===========================
  scheduler:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: crm-scheduler
    restart: unless-stopped
    working_dir: /var/www/crm
    command: sh -c "while true; do php artisan schedule:run --verbose --no-interaction; sleep 60; done"
    volumes:
      - ./:/var/www/crm
    environment:
      APP_ENV: ${APP_ENV:-production}
      DB_CONNECTION: pgsql
      DB_HOST: ${DB_HOST}
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      php:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - crm-network

  # ===========================
  # Redis
  # ===========================
  redis:
    image: redis:7-alpine
    container_name: crm-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-network

  # ===========================
  # Servi√ßo IA
  # ===========================
  ai-service:
    build:
      context: ./ai-service
      dockerfile: Dockerfile
    container_name: crm-ai-service
    restart: unless-stopped
    environment:
      DEBUG: ${AI_DEBUG:-false}
      API_KEY: ${AI_AGENT_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_PROJECT_ID: ${OPENAI_PROJECT_ID}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      DATABASE_URL: postgresql+asyncpg://${DB_USERNAME}:${DB_PASSWORD}@${DB_HOST}:5432/${DB_DATABASE}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LARAVEL_API_URL: http://nginx
      LARAVEL_INTERNAL_KEY: ${INTERNAL_API_KEY}
      # Content Creator Agent
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      GROQ_API_KEY: ${GROQ_API_KEY}
      GROQ_WHISPER_MODEL: ${GROQ_WHISPER_MODEL:-whisper-large-v3}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - crm-network

volumes:
  redis_data:

networks:
  crm-network:
    driver: bridge
